# Аудит `dashboard.js`

Ниже перечислены основные логические блоки файла `src/Http/Dashboard/Assets/dist/js/dashboard.js` с указанием страниц/модулей, используемых селекторов, событий и внешних зависимостей. Конспект можно использовать как дорожную карту для рефакторинга.

## Общие инициализации и виджеты
- **Select2 (глобально):** инициализация всех `.select2`, кроме помеченных `data-skipGlobalInit` или уже активированных; устанавливает ширину, `allowClear` и плейсхолдеры из `data-placeholder`. Зависимости: jQuery и Select2.【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L113-L133】
- **Flatpickr (фильтры по датам):** применяет календарь к `[data-role="filter-date-from"], [data-role="filter-date-to"]` с альтернативным форматом и ручным вводом. Зависимость: `window.flatpickr`. Используется в фильтрах записей и коллекций.【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L189-L208】
- **Dropzone (загрузка медиа):** инициализация `[data-role="media-dropzone"]`, отключение `autoDiscover`, настройки сообщений и ручная обработка очереди. Зависимость: Dropzone, jQuery; применяется в медиатеке и формах загрузки.【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L210-L235】
- **Sortable (списки состояний/таксономии):** включает перетаскивание для `[data-role="states-list"]` с классами призрака и событием `states:reordered`, что затем обрабатывает модуль workflow. Зависимость: Sortable.js.【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L238-L258】
- **Matrix-репитер (редактор полей):** управляет `[data-role="matrix"]`, добавляет/удаляет блоки через `data-role="matrix-add"/"matrix-remove"`, синхронизирует хранилище и поддерживает редакторы Quill либо `contenteditable` с обратным вызовом `matrix:change`. Зависимости: jQuery, Sortable.js (для перетаскивания блоков), Quill (редактор), JSON/`localStorage` для сериализации.【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L260-L373】【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L378-L520】
- **CodeMirror (редакторы кода):** превращает `[data-role="code-editor"]` в CodeMirror с режимом из `data-mode`, номерами строк и поддержкой read-only. Зависимость: CodeMirror.【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L613-L632】
- **Глобальный выбор чекбоксов:** обработчик `bindSelectAll` для `[data-role="select-all"]`, который синхронизирует состояние чекбоксов таблицы. Зависимость: jQuery; используется во всех таблицах с множественным выбором.【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L4110-L4118】
- **Заглушка массовых действий:** `bindBulkActions` реагирует на `[data-action="bulk-update"]`, собирает отмеченные строки `#activity-table` и выводит сообщение в `#bulk-action-result`. Используется как пример/заготовка без серверной логики.【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L8873-L8901】

## Блок активности (дашборд)
- **Таблица активности и предпросмотр:** `#activity-table` инициализируется DataTables без пагинации/поиска; клики по строкам выделяют их, проставляют чекбокс и обновляют карточку `#activity-preview` через `selectRow`/`updatePreview`. Зависимости: jQuery, DataTables.【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L141-L187】【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L635-L652】
- **Фильтр типа активности:** `#activity-type-filter` с кнопкой `[data-action="reset-filter"]` вызывает перерисовку DataTables через `bindFiltering`. Зависимость: jQuery, DataTables фильтры (`$.fn.dataTable.ext.search`).【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L147-L176】【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L4121-L4139】

## Управление коллекциями
- **Таблица коллекций:** `#collections-table` — серверный DataTable с колонками, кастомными атрибутами строк и чекбоксами `[data-role="collection-select"]`; клики по строкам переключают чекбоксы, а `updateCollectionsSelectionState` управляет сводкой и состоянием Select All. Зависимости: jQuery, DataTables.【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L654-L807】
- **Фильтры коллекций:** элементы `#collections-search`, `#collections-status`, `#collections-structure` и кнопка `[data-action='reset-filters']` перезагружают таблицу с дебаунсом, сбрасывая текущий saved view при ручном вводе. Используются jQuery и Select2 (для `trigger('change.select2')`).【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L845-L912】
- **Сохранённые виды коллекций:** выпадающий список `[data-role='collections-saved-view']` загружается из `localStorage` (`dashboard.collections.savedViews`), позволяет сохранять текущие фильтры и применять сохранённые наборы; при выборе сбрасывает/устанавливает фильтры и перерисовывает таблицу. Зависимости: jQuery, `localStorage`, Select2.【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L947-L1103】
- **Панель действий коллекций:** кнопки `data-action='collection-open'` и `data-action='collection-edit'` открывают соответствующие страницы выбранной коллекции (список записей/настройки) через `window.location`. Использует состояние выбранных коллекций из `getSelectedCollections`.【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L3618-L3656】
- **Экспорт коллекций:** `data-action='export-collections'` открывает модал `#collections-export`; внутри `prepareCollectionsExport` формирует данные (JSON/YAML/CSV), управляет кнопками копирования/скачивания и отображает статусы. Зависимости: jQuery, Bootstrap модальные окна (через события `shown.bs.modal`), `document.execCommand`, энкодинг данных.【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L3659-L3810】
- **Массовые действия по коллекциям:** селектор `[data-role='collections-bulk']` и кнопка `[data-action='bulk-apply']` проверяют выбранные коллекции, выводят результат в `[data-role='collections-bulk-feedback']`. Логика выполнена на клиенте; требует jQuery.【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L3907-L3959】

## Модуль схем
- **Инициализация и данные:** контейнер `[data-role="schemas"]` читает JSON-набор из `<script data-role="schemas-dataset">`, объединяет с пользовательским набором в `localStorage`, конфигурирует URL'ы и слушает `localStorage`-события для обновлений из других вкладок. Зависимости: jQuery, `localStorage`.【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L1115-L1401】
- **Таблица и предпросмотр схем:** `renderSchemasTable` строит `<tbody>` для `[data-role="schemas-table"]`, подсвечивает выделение и обновляет превью (`[data-role="schema-preview-*"`], кнопка редактирования). Зависимости: jQuery, внутренние методы форматирования.【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L2186-L2340】
- **Фильтры схем:** `#schemas-search`, `#schemas-collection` и кнопка `[data-action="schemas-reset-filters"]` фильтруют локальный набор, сбрасывая активный saved view при ручных изменениях. Зависимости: jQuery, Select2.【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L2417-L2465】
- **Сохранённые виды схем:** `[data-role="schemas-saved-view"]` комбинирует предустановленные и пользовательские виды (хранит в `dashboard.schemas.savedViews`), позволяет создавать/удалять/применять фильтры и выбранную схему. Зависимости: jQuery, `localStorage`, Select2.【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L2487-L2721】
- **Экспорт схем:** модал `#schema-export` обновляется при выборе формата (`[data-role="schemas-export-format"]`) и области (`[name="schemas-export-scope"]`), готовит файлы JSON/YAML, управляет копированием и скачиванием. Зависимости: jQuery, Bootstrap модалы, сериализация (JSON/YAML).【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L1720-L2046】
- **Действия (создание/редактирование):** кнопки `data-action="create-schema"`, `[data-role="edit-schema"]` и `data-action="export-schema"` используют сконфигурированные URL'ы и открывают модал экспорта; события ограничены пространством имён `schemasActions`. Зависимости: jQuery, window.location, Bootstrap модал.【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L1623-L1719】

## Конструктор схем
- **Инициализация:** `<script data-role="schema-builder-config">` задаёт режим (create/edit), коллекции, типы полей и пресеты; `initSchemaBuilder` подготавливает форму и автозаполнение хэндла. Зависимости: jQuery, `localStorage` (для пользовательских схем).【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L2741-L2871】
- **Строки полей:** `createSchemaFieldRow` генерирует разметку, `bindSchemaFieldRowEvents` синхронизирует название/код, реагирует на изменение типа/флагов, удаляет поле и обновляет предпросмотр. Зависимости: jQuery, утилита `slugify`.【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L3000-L3110】
- **События конструктора:** `bindSchemaBuilderEvents` обрабатывает добавление полей, сохранение (`schema-save`, `schema-save-stay`), изменения основных полей и применение пресетов. Предпросмотр обновляется в `updateSchemaBuilderPreview`. Зависимости: jQuery, внутренние методы сохранения/валидаторов.【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L3178-L3336】【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L3337-L3425】

## Автосохранение и предпросмотр элементов
- **Автосохранение формы:** контейнер `[data-role="element-form"]` отслеживает `input/change` (включая matrix события), помечает форму грязной и с отложенным вызовом `performElementAutosave`. Данные собираются из полей/`contenteditable`, сохраняются через AJAX или локально и кэшируются в `localStorage`. Зависимости: jQuery, `localStorage`, AJAX (`$.ajax`).【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L4142-L4526】
- **Предпросмотр и история:** кнопки `[data-action="toggle-preview"]` и `[data-action="open-history"]` открывают модалы `#element-preview` и `#element-history`, подгружая HTML/JSON через `fetchElementPreview`/`fetchElementHistory` и формируя таблицу версий. Зависимости: jQuery, Bootstrap модалы, AJAX.【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L4177-L4343】

## Записи выбранной коллекции
- **Таблица записей коллекции:** `#collection-entries-table` — серверный DataTable с чекбоксами `[data-role="collection-entry-select"]`, хранением выбора и обновлением сводки `[data-role="collection-entries-selection-summary"]`. Зависимости: jQuery, DataTables.【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L4928-L5080】【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L5208-L5267】
- **Фильтры записей:** поиск, статусы, локали, диапазон дат (`#collection-entries-date-from/to`), таксономии (`[data-role="entries-filter-taxonomy"]`) и дополнительные поля (`[data-role="entries-filter-field"]`) вызывают перезагрузку таблицы; предусмотрена кнопка сброса `[data-action="entries-reset-filters"]`. Зависимости: jQuery, Select2, Flatpickr (через общую инициализацию).【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L5563-L5638】
- **Сохранённые виды записей коллекции:** `data-role="collection-entries-saved-view"` загружает дефолтные и пользовательские виды из `localStorage`, поддерживает создание/удаление и восстановление всех фильтров, включая выбранный узел дерева. Зависимости: jQuery, `localStorage`, Select2.【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L5229-L5535】
- **Дерево структуры:** `[data-role="collection-entries-tree"]` переключает фильтр по родителю (`setCollectionEntriesTreeNode`) и при наличии Sortable позволяет менять порядок (`group: 'collection-entries-tree'`). Зависимости: jQuery, Sortable.js.【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L5714-L5765】
- **Колонки и массовые действия:** `[data-role="collection-entries-column-toggle"]` управляет видимостью колонок, `[data-role="collection-entries-bulk"]` и `[data-action="entries-bulk-apply"]` выводят уведомления о массовых операциях. Зависимости: jQuery, DataTables (API `column().visible`).【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L5766-L5782】【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L5669-L5713】
- **Действия над записями:** кнопки `data-action="collection-entry-create"`, `entries-open`, `entries-edit`, `collection-entry-refresh` формируют ссылки на редактирование/создание и открывают новые вкладки. Зависимости: jQuery, `window.open/location`.【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L4844-L4916】

## Управление связями
- **Модал выбора связей:** `#relation-modal` использует Select2 для полей `[data-role="relation-source"]` и `[data-role="relation-target"]`, подгружает результаты через `searchRelationElements`, кеширует их и сохраняет выбор в `localStorage` (`dashboard.relations.selection`). Зависимости: jQuery, Select2, AJAX (через локальные Deferred).【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L5783-L6106】

## Медиатека
- **Инициализация и данные:** `[data-role="media-library"]` загружает (пока фиктивный) массив медиа, заполняет фильтры и хранит выбранный режим просмотра/отбор. Зависимости: jQuery, внутренние утилиты форматирования. 【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L6134-L6265】
- **Фильтры и режимы просмотра:** поиск (`[data-role="media-search"]`), тип, коллекция, теги и период обновляют выдачу с дебаунсом; кнопки `[data-role="media-view-mode"] button` переключают `grid/list`, а `toggle-media-filters` сворачивает панель. Зависимости: jQuery, Select2 (через общую инициализацию).【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L6360-L6427】
- **Выбор и вставка:** клики по `[data-role="media-item"]` управляют массивом `mediaLibrarySelection`, кнопки `data-action="clear-selection"` и `data-action="insert-selection"` очищают или возвращают выбранные элементы (для интеграции с редактором). Зависимости: jQuery.【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L6406-L6458】

## Таксономии
- **Загрузка и сохранение выбора:** `[data-role="taxonomy-terms"]` получает набор терминов, сохраняет последний хэндл в `localStorage` (`dashboard.taxonomy.lastHandle`) и применяет его при инициализации. Зависимости: jQuery, `localStorage`.【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L6842-L6956】
- **Фильтр и поиск:** селектор `[data-role="taxonomy-filter"]` и поле `[data-role="term-search"]` обновляют дерево терминов с задержкой. Зависимости: jQuery.【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L6982-L7019】
- **Перетаскивание терминов:** `attachTaxonomySortable` включает Sortable для `[data-role="terms-tree"]` и `[data-role="term-children"]`, после завершения пересоздаёт структуру и отображает уведомление. Зависимости: jQuery, Sortable.js.【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L7036-L7087】

## Workflow (состояния и переходы)
- **Состояния:** контейнер `[data-role="workflow-states"]` загружает список через `fetchWorkflowStates`, рендерит элементы (`states-list`), открывает модал `#state-modal` для создания/редактирования и реагирует на перетаскивание (`states:reordered`). Зависимости: jQuery, AJAX (`$.getJSON`/`$.post`), Bootstrap модалы, Sortable.js.【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L7304-L7485】
- **Переходы:** `[data-role="workflow-transitions"]` подгружает переходы, использует Select2 для выбора состояний (`data-role="transition-from/to"`) и ролей, управляет модалом `#transition-modal` (создание/редактирование/удаление). Зависимости: jQuery, Select2, Bootstrap модалы, AJAX.【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L7587-L7813】

## Глобальный список записей
- **Таблица записей:** `#entries-table` — DataTable для всех записей CMS; хранит выбор `[data-role="entries-select"]`, обновляет сводку `[data-role="entries-selection-summary"]` и синхронизирует Select All. Зависимости: jQuery, DataTables.【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L8290-L8368】
- **Фильтры:** `#entries-search`, `#entries-status`, `#entries-collection`, `#entries-locale`, `#entries-date-from/to` и кнопка `[data-action="entries-reset-filters"]` управляют серверным запросом; при ручном вводе сбрасывают активный saved view. Зависимости: jQuery, Select2, Flatpickr (через общую инициализацию).【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L8142-L8198】
- **Сохранённые виды записей:** `[data-role="entries-saved-view"]` объединяет дефолтные виды из DOM и пользовательские (`localStorage`), позволяет создавать/удалять фильтры, синхронизируя таблицу. Зависимости: jQuery, `localStorage`, Select2.【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L7871-L8093】
- **Массовые действия и колонки:** `[data-action="entries-bulk-apply"]` и `[data-role="entries-bulk"]` выводят информацию о массовых изменениях, а `[data-role="entries-column-toggle"]` управляет видимостью колонок DataTables. Зависимости: jQuery, DataTables.【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L8573-L8636】
- **Экспорт записей:** модал `#entries-export-modal` готовит экспорт выбранных записей (JSON форматы и список `collection:id`), копирует в буфер и формирует ссылку для скачивания. Зависимости: jQuery, Bootstrap модалы, `document.execCommand`.【F:src/Http/Dashboard/Assets/dist/js/dashboard.js†L8639-L8726】

